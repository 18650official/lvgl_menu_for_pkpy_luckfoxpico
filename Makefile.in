#
# Makefile Template (Makefile.in)
# This file is used by the 'configure' script to generate the final Makefile.
#

# --- Variables will be replaced by ./configure ---
CC = @CC@
prefix = @prefix@
# ------------------------------------------------

LVGL_DIR_NAME 	?= lvgl
LVGL_DIR 		?= .

# A more manageable set of warnings
WARNINGS := -Wall -Wextra -Wno-unused-parameter -Wmissing-prototypes

# Add src/ to the include path for files that use #include "lv_conf.h"
CFLAGS 			?= -O3 -g0 -I$(LVGL_DIR)/ -I$(LVGL_DIR)/src $(WARNINGS) -std=c99
LDFLAGS 		?= -lm -lpthread
BIN 			= pico-menu
BUILD_DIR 		= ./build
BUILD_OBJ_DIR 	= $(BUILD_DIR)/obj
BUILD_BIN_DIR 	= $(BUILD_DIR)/bin

bindir 			?= $(prefix)/bin

# Collect the files to compile
MAINSRC = src/main.c

# --- NEW: List of config files in src/ that need to be symlinked to the root ---
# This is required for libraries that use hardcoded relative paths like ../lv_drv_conf.h
CONF_FILES_TO_LINK := lv_conf.h lv_drv_conf.h lv_demo_conf.h

include $(LVGL_DIR)/lvgl/lvgl.mk
include $(LVGL_DIR)/lv_drivers/lv_drivers.mk

OBJEXT 			?= .o

AOBJS 			= $(ASRCS:.S=$(OBJEXT))
COBJS 			= $(CSRCS:.c=$(OBJEXT))
MAINOBJ 		= $(MAINSRC:.c=$(OBJEXT))

SRCS 			= $(ASRCS) $(CSRCS) $(MAINSRC)
# Generate a list of object files in the build directory
OBJS_IN_BUILD_DIR = $(addprefix $(BUILD_OBJ_DIR)/, $(AOBJS) $(COBJS) $(MAINOBJ))


all: default

# Generic rule for building object files
$(BUILD_OBJ_DIR)/%.o: %.c
	@mkdir -p $(dir $@)
	@$(CC) $(CFLAGS) -c $< -o $@
	@echo "  CC      $<"

# Rule for building assembly files if any
$(BUILD_OBJ_DIR)/%.o: %.S
	@mkdir -p $(dir $@)
	@$(CC) $(CFLAGS) -c $< -o $@
	@echo "  AS      $<"

# The default build target now depends on the symlinks being created first
default: $(CONF_FILES_TO_LINK) $(OBJS_IN_BUILD_DIR)
	@echo "  LD      $(BUILD_BIN_DIR)/$(BIN)"
	@mkdir -p $(BUILD_BIN_DIR)
	@$(CC) -o $(BUILD_BIN_DIR)/$(BIN) $(OBJS_IN_BUILD_DIR) $(LDFLAGS)
	@echo "Build finished: $(BUILD_BIN_DIR)/$(BIN)"

# --- NEW: A rule to create all required symlinks ---
# This rule runs once for each file in CONF_FILES_TO_LINK if the link doesn't exist
$(CONF_FILES_TO_LINK):
	@echo "  SYMLINK $@"
	@ln -sf "src/$@" "$@"

clean:
	@echo "Cleaning build directory..."
	@rm -rf $(BUILD_DIR)
	@echo "Cleaning config symlinks..."
	@rm -f $(CONF_FILES_TO_LINK)
	@echo "Clean complete."

install: all
	@echo "Installing to $(DESTDIR)$(bindir)..."
	@install -d $(DESTDIR)$(bindir)
	@install $(BUILD_BIN_DIR)/$(BIN) $(DESTDIR)$(bindir)

uninstall:
	@echo "Uninstalling from $(DESTDIR)$(bindir)..."
	@$(RM) $(DESTDIR)$(bindir)/$(BIN)

.PHONY: all default clean install uninstall

